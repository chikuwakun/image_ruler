# 比較モードバグ修正 - テスト手順

## 🐛 修正されたバグ
**問題**: 比較状態のstep2で、もう一つの定規を押した際に、クリックのコンテキストメニューが優先されて、比較状態から抜けてしまう

## ✅ 修正内容
1. **比較モード優先判定**: 比較モード中は定規クリック時にコンテキストメニューではなく比較選択を優先
2. **状態保持**: 比較モード中は選択状態をクリアしない
3. **ウィザードメッセージ改善**: step2で通常クリック・Ctrl+クリック両方が可能であることを明示

## 🧪 テスト手順

### 1. 基本的な比較フロー
1. **画像を開く**: 適当な画像をアップロード
2. **定規を2本作成**: 画像上をドラッグして定規を2本作成
3. **比較開始**: 1本目の定規をクリック（コンテキストメニューから「他の定規と比較」選択）
4. **比較step2**: 2本目の定規をクリック
   - ✅ **期待結果**: 比較が継続され、コンテキストメニューは表示されない
   - ❌ **バグ時**: コンテキストメニューが表示され、比較が中断される

### 2. Ctrl+クリック即座比較
1. **定規を2本作成**: 画像上をドラッグして定規を2本作成
2. **Ctrl+クリック**: 1本目の定規をCtrl+クリック（比較モード開始）
3. **2本目クリック**: 2本目の定規を通常クリック
   - ✅ **期待結果**: 比較完了、ウィザードがstep3に進む
   - ❌ **バグ時**: コンテキストメニューが表示される

### 3. ウィザード表示確認
1. **比較開始**: 上記いずれかの方法で比較開始
2. **ウィザード確認**: 
   - step1: 「1つ目の定規を選択」
   - step2: 「2つ目の定規を選択」メッセージ「2つ目の定規をクリックしてください（通常クリック・Ctrl+クリック どちらでも可）」
   - step3: 「比較完了！」+ 保存ボタン

### 4. 状態保持確認
1. **比較中の空白クリック**: 比較モード中に空白エリアをクリック
   - ✅ **期待結果**: 比較状態が保持され、選択が解除されない
   - ❌ **バグ時**: 比較状態がクリアされる

### 5. 比較完了後の動作
1. **比較完了**: 2本の定規で比較完了
2. **自動保存**: 比較結果が履歴に自動保存される
3. **履歴確認**: プロパティパネルの比較履歴セクションで確認可能

## 🔧 実装されたコード修正

### ImageCanvas.vue (lines 256-268)
```typescript
// 定規クリック: 比較モード中か通常クリックかを判定
if (clickedRuler) {
  // 比較モード中の場合は比較選択を優先
  if (store.isInComparisonMode) {
    store.toggleCompareSelection(clickedRuler.id)
    return
  }
  
  // 通常時は選択 + コンテキストメニュー表示
  store.selectRuler(clickedRuler.id)
  showContextMenu(clickedRuler, { x: event.clientX, y: event.clientY })
  return
}
```

### ImageCanvas.vue (lines 287-290)
```typescript
// 比較モード中でない場合のみ選択をクリア
if (!store.isInComparisonMode) {
  store.clearSelection()
}
```

### ComparisonWizard.vue (line 118)
```vue
'2つ目の定規をクリックしてください（通常クリック・Ctrl+クリック どちらでも可）'
```

## ✅ 修正確認項目
- [ ] 比較step2でコンテキストメニューが表示されない
- [ ] 比較フローが正しく継続される
- [ ] ウィザードのステップ進行が正常
- [ ] 比較結果の自動保存が動作
- [ ] 比較中の状態保持が正常
- [ ] 通常時のコンテキストメニューは正常動作

## 🎯 修正の効果
- **ユーザビリティ向上**: 比較作業が中断されず、スムーズに完了できる
- **直感的操作**: 比較モード中は比較操作が優先され、混乱がない
- **エラー防止**: 意図しないコンテキストメニュー表示によるフロー中断を防止

この修正により、比較モードの使い勝手が大幅に向上し、ユーザーが迷うことなく比較作業を完了できるようになります。